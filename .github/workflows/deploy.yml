name: FTP Deploy to InfinityFree

on:
  push:
    branches: [ main ]

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .htaccess and api/ca.pem from DB secrets
        shell: bash
        run: |
          if [ -n "${{ secrets.DB_PASS }}" ]; then
            printf '%s
'\''# Generated by GitHub Actions from repository secrets'\''
              "SetEnv DB_HOST ${{ secrets.DB_HOST }}"
              "SetEnv DB_PORT ${{ secrets.DB_PORT }}"
              "SetEnv DB_NAME ${{ secrets.DB_NAME }}"
              "SetEnv DB_USER ${{ secrets.DB_USER }}"
              "SetEnv DB_PASS ${{ secrets.DB_PASS }}"
              "SetEnv DB_SSL_CA ${{ secrets.DB_SSL_CA }}" > .htaccess
            echo ".htaccess created"
          else
            echo "DB_PASS not set — skipping .htaccess creation"
          fi

          # If a DB SSL CA PEM is provided as a secret, write it to api/ca.pem
          if [ -n "${{ secrets.DB_SSL_CA }}" ]; then
            mkdir -p api
            printf '%s' "${{ secrets.DB_SSL_CA }}" > api/ca.pem
            chmod 644 api/ca.pem
            echo "api/ca.pem created"
          else
            echo "DB_SSL_CA not set — skipping api/ca.pem creation"
          fi
      - name: Normalize FTP_REMOTE_DIR
        run: |
          dir="${{ secrets.FTP_REMOTE_DIR }}"
          if [ -n "$dir" ]; then
            case "$dir" in
              */) echo "SERVER_DIR=$dir" >> $GITHUB_ENV ;;
              *) echo "SERVER_DIR=${dir}/" >> $GITHUB_ENV ;;
            esac
          else
            echo "SERVER_DIR=/htdocs/" >> $GITHUB_ENV
            echo "FTP_REMOTE_DIR not set — defaulting SERVER_DIR=/htdocs/"
          fi
        shell: bash

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ env.SERVER_DIR }}

      - name: Site health check (inline)
        run: |
          if [ -n "${{ secrets.SITE_URL }}" ]; then
            echo "Checking ${{ secrets.SITE_URL }}"
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.SITE_URL }}")
            echo "HTTP status: $status"
            if [ "$status" -ne 200 ]; then
              echo "Site check failed: $status"
              exit 1
            fi
          else
            echo "SITE_URL not set — skipping health check"
          fi
